<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå¸‚éƒ¨é•¿ç«é€‰æ¸¸æˆ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è®¾ç½® Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* åŸºç¡€æ ·å¼ï¼Œç¡®ä¿å¸ƒå±€å±…ä¸­ä¸”ç¾è§‚ */
        body {
            background-color: #f3f4f6;
            color: #1f2937;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .metric-bar {
            height: 12px;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="app" class="container grid lg:grid-cols-4 gap-6 p-6">
        <!-- èº«ä»½ä¿¡æ¯ä¸è¿æ¥çŠ¶æ€ -->
        <div class="lg:col-span-4 bg-indigo-50 p-4 rounded-lg shadow-inner">
            <h1 class="text-2xl font-bold text-indigo-700 mb-2">åŸå¸‚æ²»ç†ä¸ç«é€‰æ¸¸æˆ</h1>
            <p id="auth-status" class="text-sm text-indigo-600">
                è¿æ¥çŠ¶æ€: <span id="connection-status">æ­£åœ¨è®¤è¯...</span>
            </p>
            <p class="text-sm text-indigo-600">
                æ‚¨çš„ç”¨æˆ·ID (ç”¨äºåŒ¹é…): <code id="user-id-display" class="font-mono bg-indigo-200 px-2 py-0.5 rounded"></code>
            </p>
        </div>

        <!-- åŸå¸‚æ ¸å¿ƒæŒ‡æ ‡ (å·¦ä¾§æˆ–é¡¶éƒ¨) -->
        <div class="lg:col-span-1 space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">åŸå¸‚æ ¸å¿ƒæŒ‡æ ‡</h2>

            <div id="metrics-display" class="space-y-4 p-4 bg-white rounded-lg shadow">
                <!-- åŠ¨æ€æŒ‡æ ‡åˆ—è¡¨ -->
            </div>

            <div class="p-4 bg-gray-100 rounded-lg shadow">
                <h3 class="font-semibold text-lg mb-2 text-gray-700">æ¸¸æˆçŠ¶æ€</h3>
                <p>å½“å‰å›åˆ: <span id="current-turn" class="font-bold text-blue-600">0</span></p>
                <p>å¸‚é•¿ç«é€‰å›åˆ: <span id="election-turn" class="font-bold text-red-600">10</span></p>
                <div class="mt-4">
                    <button id="start-game-btn" onclick="startGame()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:bg-gray-400">
                        å¼€å§‹æ–°æ¸¸æˆ (é‡ç½®)
                    </button>
                    <button id="next-turn-btn" onclick="nextTurn()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:bg-gray-400" disabled>
                        è¿›å…¥ä¸‹ä¸€å›åˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- æ”¿ç­–ææ¡ˆä¸è§’è‰²åŒº (ä¸­é—´) -->
        <div class="lg:col-span-2 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">è§’è‰²ä¸æ”¿ç­–ææ¡ˆ</h2>

            <!-- è§’è‰²åˆ†é… -->
            <div id="roles-status" class="bg-yellow-50 p-4 rounded-lg shadow-md">
                <h3 class="font-semibold text-lg mb-2 text-gray-700">å½“å‰è§’è‰²åˆ†é… (ç©å®¶ID: è§’è‰²)</h3>
                <div id="role-list" class="space-y-1 text-sm">
                    <!-- åŠ¨æ€è§’è‰²åˆ—è¡¨ -->
                    <p class="text-gray-500">ç­‰å¾…åŠ è½½...</p>
                </div>
            </div>

            <!-- æ”¿ç­–ææ¡ˆè¡¨å• -->
            <div id="proposal-form-container" class="p-4 bg-white rounded-lg shadow-lg border border-gray-200">
                <h3 class="font-semibold text-xl mb-3 text-indigo-600">æå‡ºæ–°æ”¿ç­–</h3>
                <div id="my-role-display" class="mb-3 text-sm font-medium">æ‚¨çš„è§’è‰²: <span class="font-bold text-purple-600">æœªåˆ†é…</span></div>

                <div class="space-y-4">
                    <div>
                        <label for="policy-type" class="block text-sm font-medium text-gray-700">æ”¿ç­–ç±»å‹ (å½±å“æŒ‡æ ‡)</label>
                        <select id="policy-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="Security">æ²»å®‰æ”¿ç­– (è­¦å¯Ÿå±€)</option>
                            <option value="Health">å¥åº·æ”¿ç­– (å¸‚æ”¿å…/å«å¥)</option>
                            <option value="Construction">å»ºè®¾æ”¿ç­– (åœŸåœ°å±€)</option>
                            <option value="Economy">ç»æµæ”¿ç­– (ç¨æ”¶éƒ¨)</option>
                        </select>
                    </div>
                    <div>
                        <label for="policy-cost" class="block text-sm font-medium text-gray-700">æ”¿ç­–é¢„ç®— (å½±å“åŸå¸‚é¢„ç®—)</label>
                        <input type="number" id="policy-cost" min="50" max="500" value="100" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="policy-description" class="block text-sm font-medium text-gray-700">æ”¿ç­–æè¿° (è¯´æ˜æ”¿ç­–å†…å®¹)</label>
                        <textarea id="policy-description" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2" placeholder="ä¾‹å¦‚ï¼šå¢åŠ ç¤¾åŒºå·¡é€»åŠ›åº¦ï¼Œæå‡æ²»å®‰è¯„åˆ†ã€‚" required></textarea>
                    </div>
                    <button onclick="proposePolicy()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:bg-gray-400" id="propose-btn">
                        æå‡ºæ”¿ç­–
                    </button>
                </div>
            </div>
        </div>

        <!-- æ”¿ç­–å®¡æ‰¹ä¸äº¤æµåŒº (å³ä¾§) -->
        <div class="lg:col-span-1 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">æ”¿ç­–å®¡æ‰¹ä¸äº¤æµ</h2>

            <!-- å¾…å®¡æ‰¹æ”¿ç­–åˆ—è¡¨ -->
            <div class="p-4 bg-white rounded-lg shadow-lg border border-red-200">
                <h3 class="font-semibold text-lg mb-3 text-red-600">å¾…å®¡æ‰¹æ”¿ç­–</h3>
                <div id="pending-policies" class="space-y-3">
                    <p class="text-gray-500 text-sm">æš‚æ— å¾…å®¡æ‰¹æ”¿ç­–ã€‚</p>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆæ¶ˆæ¯/ç»“æœ Modal -->
        <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 text-center text-blue-700"></h3>
                <p id="modal-message" class="mb-6 text-gray-700 text-center"></p>
                <button onclick="closeModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    ç¡®è®¤
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨å±€å˜é‡ä¸é…ç½® ---
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let currentRole = 'Unassigned';
        let gameState = {};
        let gameMetrics = {};
        let gameRoles = {};

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const FIREBASE_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const ELECTION_TURN = 10;
        const GAME_STATE_PATH = `artifacts/${APP_ID}/public/data/city_game/master_state`;
        const PROPOSALS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/city_game/proposals`;

        // æ ¸å¿ƒæŒ‡æ ‡é…ç½®
        const METRIC_CONFIG = {
            Satisfaction: { name: 'å¸‚æ°‘æ»¡æ„åº¦', color: 'bg-yellow-500', minChange: 2, maxChange: 8, baseImpact: 0.1 },
            Budget: { name: 'åŸå¸‚é¢„ç®— (K)', color: 'bg-green-500', minChange: -100, maxChange: 300, isCurrency: true },
            Health: { name: 'å¥åº·åº¦', color: 'bg-red-500', minChange: 5, maxChange: 15, baseImpact: 0.2 },
            Security: { name: 'æ²»å®‰åº¦', color: 'bg-blue-500', minChange: 5, maxChange: 15, baseImpact: 0.2 },
            Construction: { name: 'åŸå¸‚å»ºè®¾', color: 'bg-indigo-500', minChange: 5, maxChange: 15, baseImpact: 0.2 },
            Economy: { name: 'äº§ä¸šé“¾/ç‰©ä»·', color: 'bg-purple-500', minChange: 5, maxChange: 15, baseImpact: 0.2 },
        };

        const ROLES_MAP = {
            Mayor: 'å¸‚æ”¿å…/å¸‚é•¿ (å®¡æ‰¹)',
            Security: 'è­¦å¯Ÿå±€ (æ²»å®‰)',
            Construction: 'åœŸåœ°å±€ (å»ºè®¾)',
            Economy: 'ç¨æ”¶éƒ¨ (ç»æµ)',
            Health: 'å«å¥éƒ¨ (å¥åº·)',
        };

        // --- å·¥å…·å‡½æ•° (ç”¨äºæ˜¾ç¤ºæ¶ˆæ¯) ---
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // --- Firebase åˆå§‹åŒ–ä¸è®¤è¯ ---

        async function initFirebase() {
            try {
                if (Object.keys(FIREBASE_CONFIG).length === 0) {
                    console.error("Firebase Configuration is missing.");
                    document.getElementById('connection-status').textContent = "é”™è¯¯ï¼šFirebaseé…ç½®ç¼ºå¤±ã€‚";
                    return;
                }

                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('connection-status').textContent = "æ­£åœ¨ç™»å½•...";

                // è®¤è¯
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        document.getElementById('connection-status').textContent = "å·²è¿æ¥å¹¶è®¤è¯";
                        startListening();
                    } else {
                        document.getElementById('connection-status').textContent = "è®¤è¯å¤±è´¥ï¼Œè¯·åˆ·æ–°ã€‚";
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('connection-status').textContent = `è¿æ¥å¤±è´¥: ${error.message}`;
            }
        }

        // --- æ¸¸æˆé€»è¾‘ï¼šåˆå§‹åŒ–ä¸é‡ç½® ---

        window.startGame = async function() {
            if (!db || !userId) return;

            const initialMetrics = {
                Satisfaction: 50,
                Budget: 1000, // K
                Health: 50,
                Security: 50,
                Construction: 50,
                Economy: 50,
            };

            const initialRoles = {
                [userId]: 'Mayor', // é»˜è®¤å‘èµ·è€…æ˜¯å¸‚é•¿
            };

            const initialState = {
                metrics: initialMetrics,
                roles: initialRoles,
                currentTurn: 0,
                electionTurn: ELECTION_TURN,
                lastReset: Date.now(),
            };

            try {
                await setDoc(doc(db, GAME_STATE_PATH), initialState);
                // æ¸…ç©ºæ—§æ”¿ç­–
                const q = query(collection(db, PROPOSALS_COLLECTION_PATH));
                const snapshot = await getDocs(q);
                snapshot.forEach(async (d) => {
                    await deleteDoc(doc(db, PROPOSALS_COLLECTION_PATH, d.id));
                });
                showModal('æ¸¸æˆå·²é‡ç½®', 'æ–°çš„åŸå¸‚å·²å»ºç«‹ï¼Œæ‚¨ç°åœ¨æ˜¯å¸‚é•¿ï¼');
            } catch (error) {
                console.error("Failed to start game:", error);
                showModal('é”™è¯¯', `æ— æ³•å¼€å§‹æ¸¸æˆ: ${error.message}`);
            }
        }

        // --- æ¸¸æˆé€»è¾‘ï¼šå›åˆæ¨è¿›ä¸æ•ˆæœç»“ç®— ---

        window.nextTurn = async function() {
            if (!db || currentRole !== 'Mayor' || gameState.currentTurn >= gameState.electionTurn) return;

            document.getElementById('next-turn-btn').disabled = true;
            document.getElementById('next-turn-btn').textContent = 'æ­£åœ¨ç»“ç®—...';

            let newMetrics = { ...gameMetrics };
            let totalCost = 0;

            try {
                // 1. è·å–æ‰€æœ‰å·²æ‰¹å‡†ä½†æœªæ‰§è¡Œçš„æ”¿ç­–
                const q = query(collection(db, PROPOSALS_COLLECTION_PATH), where("status", "==", "Approved"));
                const snapshot = await getDocs(q);

                snapshot.forEach(d => {
                    const policy = d.data();
                    const metricKey = policy.type;
                    const cost = policy.cost;

                    if (newMetrics.Budget >= cost) {
                        // æ‰£é™¤é¢„ç®—
                        newMetrics.Budget -= cost;
                        totalCost += cost;

                        // å½±å“å¯¹åº”æŒ‡æ ‡
                        const impact = Math.floor(Math.random() * (METRIC_CONFIG[metricKey].maxChange - METRIC_CONFIG[metricKey].minChange + 1)) + METRIC_CONFIG[metricKey].minChange;
                        newMetrics[metricKey] = Math.min(100, Math.max(0, newMetrics[metricKey] + impact));

                        console.log(`Executed Policy: ${policy.description}, Impact: ${metricKey} +${impact}, Cost: ${cost}`);

                        // æ ‡è®°ä¸ºå·²æ‰§è¡Œå¹¶åˆ é™¤
                        deleteDoc(doc(db, PROPOSALS_COLLECTION_PATH, d.id));
                    } else {
                        // é¢„ç®—ä¸è¶³ï¼Œæ”¿ç­–ä½œåºŸ
                        deleteDoc(doc(db, PROPOSALS_COLLECTION_PATH, d.id));
                        showModal('é¢„ç®—ä¸è¶³', `æ”¿ç­– "${policy.description}" å› é¢„ç®—ä¸è¶³ (ç¼ºå°‘ ${cost - newMetrics.Budget}K) æœªèƒ½æ‰§è¡Œï¼Œå·²è¢«ç§»é™¤ã€‚`);
                    }
                });

                // 2. åŸºç¡€æ»¡æ„åº¦ä¸æŒ‡æ ‡ç›¸äº’å½±å“ (ç®€åŒ–çš„æ¨¡æ‹Ÿ)
                // æ»¡æ„åº¦å—å…¶ä»–æŒ‡æ ‡å¹³å‡å€¼å½±å“
                const avgMetric = (newMetrics.Health + newMetrics.Security + newMetrics.Construction + newMetrics.Economy) / 4;
                const satisfactionChange = Math.round((avgMetric - newMetrics.Satisfaction) * 0.1) + Math.floor(Math.random() * 3) - 1; // +/- 2
                newMetrics.Satisfaction = Math.min(100, Math.max(0, newMetrics.Satisfaction + satisfactionChange));

                // åŸºç¡€è´¢æ”¿æ”¶å…¥ (æ¯å›åˆå›ºå®šæ”¶å…¥ + ç»æµåº¦å½±å“)
                const baseIncome = 200;
                const economyBonus = Math.round(newMetrics.Economy * 0.5);
                newMetrics.Budget += baseIncome + economyBonus;

                // 3. æ›´æ–°æ¸¸æˆçŠ¶æ€
                await updateDoc(doc(db, GAME_STATE_PATH), {
                    metrics: newMetrics,
                    currentTurn: gameState.currentTurn + 1
                });

                showModal('å›åˆç»“ç®—å®Œæˆ', `ç¬¬ ${gameState.currentTurn + 1} å›åˆå·²å¼€å§‹ï¼\næ‰§è¡Œæ”¿ç­–æ€»æˆæœ¬: ${totalCost}Kã€‚\nå¸‚æ°‘æ»¡æ„åº¦å˜åŒ–: ${satisfactionChange >= 0 ? '+' : ''}${satisfactionChange}ã€‚`);

            } catch (error) {
                console.error("Next turn failed:", error);
                showModal('é”™è¯¯', `å›åˆç»“ç®—å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('next-turn-btn').disabled = false;
                document.getElementById('next-turn-btn').textContent = 'è¿›å…¥ä¸‹ä¸€å›åˆ';
            }
        }

        // --- æ¸¸æˆé€»è¾‘ï¼šæ”¿ç­–ææ¡ˆ ---

        window.proposePolicy = async function() {
            if (!db || currentRole === 'Unassigned' || currentRole === 'Mayor') {
                showModal('æ— æ³•ææ¡ˆ', 'æ‚¨å¿…é¡»æ˜¯éƒ¨é•¿æ‰èƒ½ææ¡ˆ (éå¸‚é•¿)ã€‚');
                return;
            }

            const policyType = document.getElementById('policy-type').value;
            const policyCost = parseInt(document.getElementById('policy-cost').value);
            const policyDescription = document.getElementById('policy-description').value.trim();

            if (!policyDescription || isNaN(policyCost) || policyCost < 50 || policyCost > 500) {
                showModal('é”™è¯¯', 'è¯·ç¡®ä¿æ”¿ç­–æè¿°ä¸ä¸ºç©ºï¼Œä¸”é¢„ç®—åœ¨50-500Kä¹‹é—´ã€‚');
                return;
            }

            const requiredRole = policyType; // æ”¿ç­–ç±»å‹ä¸æ‰€éœ€è§’è‰²ä¸€è‡´ (ç®€åŒ–)
            if (currentRole !== requiredRole) {
                showModal('é”™è¯¯', `æ‚¨æ˜¯ ${ROLES_MAP[currentRole].split(' ')[0]}ï¼Œåªèƒ½ææ¡ˆ ${ROLES_MAP[requiredRole].split(' ')[0]} æ”¿ç­–ï¼`);
                return;
            }

            const newPolicy = {
                proposerId: userId,
                role: currentRole,
                type: policyType,
                cost: policyCost,
                description: policyDescription,
                status: 'Pending', // ç­‰å¾…å¸‚é•¿å®¡æ‰¹
                timestamp: Date.now()
            };

            try {
                await addDoc(collection(db, PROPOSALS_COLLECTION_PATH), newPolicy);
                showModal('ææ¡ˆæˆåŠŸ', `æ‚¨çš„ ${ROLES_MAP[currentRole].split(' ')[0]} æ”¿ç­–å·²æäº¤ï¼Œç­‰å¾…å¸‚é•¿å®¡æ‰¹ã€‚`);
                document.getElementById('policy-description').value = ''; // æ¸…ç©ºè¡¨å•
            } catch (error) {
                console.error("Failed to propose policy:", error);
                showModal('é”™è¯¯', `ææ¡ˆå¤±è´¥: ${error.message}`);
            }
        }

        // --- æ¸¸æˆé€»è¾‘ï¼šæ”¿ç­–å®¡æ‰¹ ---

        window.approvePolicy = async function(policyId) {
            if (!db || currentRole !== 'Mayor') return;
            try {
                await updateDoc(doc(db, PROPOSALS_COLLECTION_PATH, policyId), { status: 'Approved' });
            } catch (error) {
                console.error("Failed to approve policy:", error);
            }
        }

        window.rejectPolicy = async function(policyId) {
            if (!db || currentRole !== 'Mayor') return;
            try {
                // ç›´æ¥åˆ é™¤è¢«æ‹’ç»çš„æ”¿ç­–
                await deleteDoc(doc(db, PROPOSALS_COLLECTION_PATH, policyId));
            } catch (error) {
                console.error("Failed to reject policy:", error);
            }
        }

        // --- å®æ—¶æ•°æ®ç›‘å¬å™¨ ---

        function startListening() {
            if (!db) return;

            // 1. ç›‘å¬æ¸¸æˆçŠ¶æ€ (Metrics, Turn, Roles)
            onSnapshot(doc(db, GAME_STATE_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    gameState = docSnap.data();
                    gameMetrics = gameState.metrics;
                    gameRoles = gameState.roles;
                    updateUI(gameState);

                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†é…è§’è‰²
                    if (!gameRoles[userId]) {
                        assignRoleToNewPlayer();
                    } else {
                        currentRole = gameRoles[userId];
                        document.getElementById('my-role-display').innerHTML = `æ‚¨çš„è§’è‰²: <span class="font-bold text-purple-600">${ROLES_MAP[currentRole]}</span>`;
                        // åªæœ‰å¸‚é•¿å¯ä»¥ç‚¹å‡»ä¸‹ä¸€å›åˆ
                        document.getElementById('next-turn-btn').disabled = (currentRole !== 'Mayor' || gameState.currentTurn >= gameState.electionTurn);
                    }

                    // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                    if (gameState.currentTurn >= gameState.electionTurn) {
                        endGame();
                    }

                } else {
                    // æ¸¸æˆçŠ¶æ€ä¸å­˜åœ¨ï¼Œæç¤ºå¼€å§‹æ–°æ¸¸æˆ
                    updateEmptyUI();
                }
            });

            // 2. ç›‘å¬æ”¿ç­–ææ¡ˆ
            onSnapshot(collection(db, PROPOSALS_COLLECTION_PATH), (snapshot) => {
                const policies = [];
                snapshot.forEach(d => policies.push({ id: d.id, ...d.data() }));
                renderPolicies(policies);
            });
        }

        async function assignRoleToNewPlayer() {
            const occupiedRoles = Object.values(gameRoles);
            const availableRoles = Object.keys(ROLES_MAP).filter(role => !occupiedRoles.includes(role));

            if (availableRoles.length > 0) {
                const newRole = availableRoles[0];
                const newRoles = { ...gameRoles, [userId]: newRole };

                try {
                    await updateDoc(doc(db, GAME_STATE_PATH), { roles: newRoles });
                    currentRole = newRole;
                    showModal('è§’è‰²åˆ†é…', `æ­å–œï¼æ‚¨å·²è¢«åˆ†é…ä¸º ${ROLES_MAP[newRole].split(' ')[0]}ã€‚`);
                } catch (e) {
                    console.error("Failed to assign role:", e);
                }
            } else {
                currentRole = 'Spectator';
                document.getElementById('my-role-display').innerHTML = `æ‚¨çš„è§’è‰²: <span class="font-bold text-gray-500">è§‚å¯Ÿè€… (è§’è‰²å·²æ»¡)</span>`;
            }
        }

        function endGame() {
            const satisfaction = gameMetrics.Satisfaction;
            const message = `æ¸¸æˆç»“æŸï¼å¸‚é•¿ç«é€‰å¼€å§‹ã€‚\næœ¬è½®åŸå¸‚æœ€ç»ˆæ»¡æ„åº¦ä¸º ${satisfaction}ã€‚\n\nğŸ‰ ç«é€‰ç»“æœï¼šç”± Satisfaction æœ€é«˜çš„ç©å®¶èƒœå‡º (æ­¤ç‰ˆæœ¬ç®€åŒ–ä¸ºï¼šæ»¡æ„åº¦å³ä¸ºæœ€ç»ˆç»“æœ)ã€‚`;

            document.getElementById('next-turn-btn').disabled = true;
            document.getElementById('next-turn-btn').textContent = 'æ¸¸æˆå·²ç»“æŸ';

            showModal('å¸‚é•¿ç«é€‰ç»“æœ', message);
        }

        // --- UI æ¸²æŸ“å‡½æ•° ---

        function updateUI(state) {
            document.getElementById('current-turn').textContent = state.currentTurn;
            document.getElementById('election-turn').textContent = state.electionTurn;
            document.getElementById('start-game-btn').disabled = false;

            // æ¸²æŸ“æŒ‡æ ‡
            const metricsHtml = Object.keys(METRIC_CONFIG).map(key => {
                const config = METRIC_CONFIG[key];
                const value = state.metrics[key];
                const displayValue = config.isCurrency ? `${value}K` : `${value}%`;
                const progressWidth = config.isCurrency ? '100%' : `${value}%`;

                return `
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">${config.name}</span>
                            <span class="text-base font-bold text-gray-800">${displayValue}</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-3">
                            <div class="metric-bar ${config.color}" style="width: ${progressWidth};"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('metrics-display').innerHTML = metricsHtml;

            // æ¸²æŸ“è§’è‰²åˆ—è¡¨
            const roleListHtml = Object.keys(state.roles).map(uid => {
                const roleKey = state.roles[uid];
                const roleName = ROLES_MAP[roleKey] || 'æœªçŸ¥è§’è‰²';
                const isMe = uid === userId ? ' (æ‚¨)' : '';
                return `<p class="truncate">${uid.substring(0, 8)}...${isMe}: <span class="font-semibold text-green-700">${roleName}</span></p>`;
            }).join('');
            document.getElementById('role-list').innerHTML = roleListHtml;
        }

        function updateEmptyUI() {
            document.getElementById('metrics-display').innerHTML = '<p class="text-center text-gray-500">ç‚¹å‡»â€œå¼€å§‹æ–°æ¸¸æˆâ€æ¥åˆå§‹åŒ–åŸå¸‚çŠ¶æ€ã€‚</p>';
            document.getElementById('next-turn-btn').disabled = true;
            document.getElementById('next-turn-btn').textContent = 'è¿›å…¥ä¸‹ä¸€å›åˆ';
            document.getElementById('start-game-btn').disabled = false;
        }

        function renderPolicies(policies) {
            const pendingPolicies = policies.filter(p => p.status === 'Pending');
            const pendingContainer = document.getElementById('pending-policies');

            if (pendingPolicies.length === 0) {
                pendingContainer.innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— å¾…å®¡æ‰¹æ”¿ç­–ã€‚</p>';
                return;
            }

            const policiesHtml = pendingPolicies.map(policy => {
                const proposerShortId = policy.proposerId.substring(0, 8) + '...';
                const actionButtons = currentRole === 'Mayor' ? `
                    <div class="flex space-x-2 mt-2">
                        <button onclick="approvePolicy('${policy.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded-lg transition duration-150">
                            æ‰¹å‡† (é€šè¿‡)
                        </button>
                        <button onclick="rejectPolicy('${policy.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-lg transition duration-150">
                            å¦å†³ (åˆ é™¤)
                        </button>
                    </div>
                ` : `<p class="text-xs text-gray-500 mt-2">ç­‰å¾…å¸‚é•¿å®¡æ‰¹...</p>`;

                return `
                    <div class="border border-gray-100 p-3 rounded-lg bg-white shadow-sm">
                        <p class="font-bold text-sm text-gray-800">ã€${ROLES_MAP[policy.role].split(' ')[0]} ææ¡ˆã€‘</p>
                        <p class="text-sm my-1">${policy.description}</p>
                        <p class="text-xs text-indigo-500">é¢„ç®—: ${policy.cost}K | ç›®æ ‡: ${METRIC_CONFIG[policy.type].name}</p>
                        <p class="text-xs text-gray-500">ææ¡ˆäºº: ${proposerShortId}</p>
                        ${actionButtons}
                    </div>
                `;
            }).join('');

            pendingContainer.innerHTML = policiesHtml;
        }

        // --- å¯åŠ¨åº”ç”¨ç¨‹åº ---
        initFirebase();
    </script>
</body>
</html>